[vars]
bucket_path = "https://ratio-synthetic-claims-fmkqn8kdews2dq6eci.t3.storage.dev/archives"


[env]
DBT_PROFILES_DIR="{{ cwd }}"
UV_NO_MANAGED_PYTHON = true

[tools]
duckdb = "latest"
python = "3.13.9"
uv = "latest"

[settings]
python.uv_venv_auto = true
idiomatic_version_file_enable_tools = []

[tasks."data:load"]
hide = true
description = "Load CSV data into the database"
run = """
#!/usr/bin/env bash

set -euo pipefail

duckdb dev.duckdb -f create.sql
for table in beneficiary_summaries carrier_claims inpatient_claims outpatient_claims rx_drug_events; do
  echo "Loading $table"
  time duckdb dev.duckdb -c "use raw; load zipfs; copy $table from 'zip://archives/$table*.zip/*.csv';"
done
"""
sources = ["archives/*.zip"]
outputs = ["dev.duckdb"]

[tasks.clean]
quiet = true
hide = true
sources = ["dev.duckdb", ".venv/"]
run = '''
#!/usr/bin/env bash

set -euo pipefail

rm -rf {{ task_source_files() | join(sep=" ") }}
'''

[tasks."data:get"]
hide = true
description = "Download the claims data archives from CMS"
run = '''
#!/usr/bin/env bash

set -euo pipefail

mkdir -p archives
cd archives

curl -O "{{ vars.bucket_path }}/beneficiary_summaries_20[08-10]_[01-03].zip"
curl -O "{{ vars.bucket_path }}/carrier_claims_[01-03][A-B].zip"
curl -O "{{ vars.bucket_path }}/inpatient_claims_[01-03].zip"
curl -O "{{ vars.bucket_path }}/outpatient_claims_[01-03].zip"
curl -O "{{ vars.bucket_path }}/rx_drug_events_[01-03].zip"
'''

[tasks.zip-stats]
hide = true
description = "Compute the total file size of uncompressed archives in the archives/"
run = '''
#!/usr/bin/env bash

set -euo pipefail

total=0

for zip in "${usage_dir}"/*.zip; do
  [[ -e "$zip" ]] || continue
  size=$(unzip -l "$zip" | tail -1 | awk '{print $1}')
  total=$((total + size))
done

echo "$total" | numfmt --to=iec --suffix=B
'''
usage = '''
flag "--dir <dir>" help="Directory of zip files" default="archives"
'''
quiet = true
